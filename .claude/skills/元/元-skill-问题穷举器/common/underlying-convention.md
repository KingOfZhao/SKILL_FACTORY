# 无限物理实践/Skill 树穷举器 - 底层约定（优化版）

## 强制执行顺序
1. 读取本文件
2. 检查 MCP 可用性（文件系统 MCP）
3. 检查 checkpoint 存在
4. 无 checkpoint 或 checkpoint 过期 → 强制询问模式选择
5. 有 checkpoint → 验证模式匹配，加载对应文件
6. 执行树状穷举（横向 + 纵向）
7. 每轮输出 5-15 个实践
8. 保守估计后提示用户保存/继续
9. 更新 checkpoint
10. 输出 10 分钟验证指南

## MCP 依赖检查

### 启动时检查
- 检测文件系统 MCP 是否连接
- 未连接时提示用户配置
- 询问是否继续无 checkpoint 模式

### 错误处理
- 保存失败 → 清晰错误 + 建议
- MCP 未连接 → 配置提示
- 权限问题 → 权限修复建议

## 模式选择（必须执行）

### 触发条件
- 首次运行
- checkpoint 不存在或已清空
- checkpoint 过期（> 24小时）
- 用户明确要求重新选择模式
- 用户输入"切换模式"

### 询问模板（必须原样输出）
```
请先明确你要穷举的模式（回复数字或关键词即可）：

1. 物理实践穷举
   → 真实世界可动手、可观察的具体物理行动、实验、材料使用、流程操作等。

2. 最小 Skill 树实践穷举
   → 针对 Skill 体系的最小化定义、拆分树、单一职责模块、依赖关系等。

请输入 1 或 2（或对应关键词）。
```

### 模式匹配（宽松匹配）
```yaml
物理实践匹配:
  - 数字: 1, 一
  - 关键词: 物理实践, physical, 物, 实践, 动手, 实验

最小 Skill 树匹配:
  - 数字: 2, 二
  - 关键词: skilltree, skill树, skill, 树, 体系, 结构

默认行为:
  - 匹配任一关键词 → 进入对应模式
  - 未匹配 → 重复询问一次
  - 有对应 checkpoint → 跳过询问，直接继续
```

### 继续命令规则
- 输入"继续" → 恢复最近一次使用的模式
- 输入"继续 物理实践" → 强制切换到物理实践模式
- 输入"继续 skill树" → 强制切换到 Skill 树模式
- 输入"切换模式" → 重新选择模式（重置 checkpoint）

## Checkpoint 机制（核心）

### 文件分离
- 物理实践：`enumeration_checkpoint_physical.json`
- 最小 Skill 树：`enumeration_checkpoint_skilltree.json`

### 格式（带版本控制）
```json
{
  "version": 1,
  "mode": "physical" | "skilltree",
  "problem": "用户原始问题",
  "current_node": "level-N.branch-M",
  "enumerated_so_far": ["实践1", "实践2"],
  "next_pending_branches": ["branch-X", "branch-Y"],
  "timestamp": "ISO8601",
  "created_at": "ISO8601",
  "previous_version_file": "enumeration_checkpoint_physical_v0.json"
}
```

### 保存策略（保守估计）
由于无法直接获取上下文剩余量：
- 每输出 5-10 个实践节点后提示用户
- 用户明确回复"保存" → 立即保存
- 用户回复"继续" → 继续输出下一批
- 每次提示：已输出 X 个实践，如感觉上下文快满了，请回复「保存」或「继续」

### 保存后回复
"节点已保存到 [文件路径]，下次输入任意内容即可继续。"

### 保存失败处理
```
保存失败：无写权限 / MCP 未连接。
节点已丢失，请手动复制本次输出保存。
```

### 版本控制
- 每次保存增加 version 字段
- 保存旧版本到带版本号的文件名
- 形成链式历史：v0 → v1 → v2...

## 输出规范（分模式）

### 物理实践模式输出
```
1. 实践列表（5-15 个）:
   - 编号
   - 标题
   - 描述
   - 执行步骤（1-2-3...）
   - 所需材料
   - 预期观察（物理反馈）
   - 安全注意事项
   - 耗时估算
   - 成本估算

2. 树状结构预览（ASCII 树）

3. checkpoint 文件路径

4. 10 分钟验证指南
```

### 最小 Skill 树模式输出
```
1. Skill 列表（5-15 个）:
   - 编号
   - Skill 名称（kebab-case）
   - 单一职责描述
   - 输入规范
   - 输出规范
   - 依赖 Skill 列表
   - 潜在 MCP 需求
   - 10 分钟验证方式

2. 树状结构预览（ASCII 树）

3. checkpoint 文件路径

4. 10 分钟验证指南
```

### 继续输出开头
"检测到 [物理实践 / 最小 Skill 树] checkpoint，继续从节点 X 穷举。"

## 上下文管理

### 用户手动触发命令
- `保存` - 强制保存当前进度
- `检查上下文` - 显示估算的上下文状态
- `切换模式` - 重新选择模式（重置 checkpoint）

### 建议
推荐安装 Claude Code Usage Tracker 扩展辅助监控上下文。

## 禁止事项
- 严禁修改自身元文件（SKILL.md, description.md）
- 严禁在运行过程中修改此约定文件
- 严禁混淆两种模式的 checkpoint 文件
- 严禁在未选择模式的情况下开始穷举
- 违反以上规则 → 立即停止并报告："检测到违规操作，已终止"

## 10 分钟验证原则

### 验证步骤
1. 打开项目文件夹 → 查看 checkpoint 文件（<10秒）
2. 阅读实践/Skill 列表（3分钟）
3. 任选 1 个实践/Skill 尝试（5分钟）
4. 对比判断（<1分钟）

### 成功标志
- checkpoint 文件已更新
- 至少 1 个实践可立即动手验证

## 边界控制

- 每轮输出：5-15 个实践/Skill
- 树状深度：建议不超过 5 层
- 保存触发：每 5-10 个节点后或用户明确要求

## 本约定为只读约定
本文件内容由人类或专用修复 Skill 维护。Skill 自身无权更改。

永久有效，所有执行必须严格遵守。
